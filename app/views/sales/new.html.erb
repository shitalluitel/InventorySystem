<div class="row">
  <div class="col-md-6 col-md-offset-3">

    <% if @sale.errors.any? %>
        <div class="alert alert-error">
          <button type="button" class="close" data-dismiss="alert">Ã—</button>
          <ul>
            <% @sale.errors.full_messages.each do |message| %>
                <li><%= message %></li>
            <% end %>
          </ul>
        </div>
    <% end %>
  </div>
</div>


<div class="row">
  <div class="col-md-12">
    <div class="ui-widget">
      <%= form_for (@sale) do |f| %>
          <table class="table table-hover ">
            <thead class="bg-primary">
            <tr>
              <th>S.N.</th>
              <th>Particular/Item</th>
              <th>unit</th>
              <th>price</th>
              <th>Est. Price</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
            </thead>

            <tbody id="add-data">
            <tr>
              <td>1</td>
              <td class="col-md-4">
                <select class="form-control" name="sale[item_id]" id="sale_item_id">
                  <option value="">Select one</option>
                  <% @item.each do |f| %>
                      <option value="<%= f.id %>"><%= f.name %></option>
                  <% end %>
                </select>
              </td>
              <td class="col-md-2">
                <input autofocus="autofocus" class="form-control unit-data" type="text" name="sale[quantity]" id="sale_quantity">
              </td>
              <td class="col-md-2">
                <input autofocus="autofocus" class="form-control price-data" type="text" name="sale[unit_cost_price]" id="sale_cost">
              </td>
              <td class="col-md-2">
                <input autofocus="autofocus" class="form-control total-cost" type="text" readonly="true" id="sale_quantity">
              </td>
              <td><a class="btn btn-primary add-new fa fa-plus">&nbsp; Add</a>
              </td>
            </tr>
            </tbody>
          </table>
          <%= f.submit "create", :class => "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>

<script type="text/javascript" charset="utf-8">
  $(function () {
    $.widget("custom.combobox", {
      _create: function () {
        this.wrapper = $("<span>")
            .addClass("custom-combobox sell_item_select")
            .insertAfter(this.element);

        this.element.hide();
        this._createAutocomplete();
      },

      _createAutocomplete: function () {
        var selected = this.element.children(":selected"),
            value = selected.val() ? selected.text() : "";

        this.input = $("<input>")
            .appendTo(this.wrapper)
            .val(value)
            .attr("title", "")
            .addClass("form-control ")
            .autocomplete({
              delay: 0,
              minLength: 0,
              source: $.proxy(this, "_source")
            })
            .tooltip({
              classes: {
                "ui-tooltip": "ui-state-highlight"
              }
            });

        this._on(this.input, {
          autocompleteselect: function (event, ui) {
            ui.item.option.selected = true;
            this._trigger("select", event, {
              item: ui.item.option
            });
          },

          autocompletechange: "_removeIfInvalid"
        });
      },

      _source: function (request, response) {
        var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
        response(this.element.children("option").map(function () {
          var text = $(this).text();
          if (this.value && ( !request.term || matcher.test(text) ))
            return {
              label: text,
              value: text,
              option: this
            };
        }));
      },

      _removeIfInvalid: function (event, ui) {

        // Selected an item, nothing to do
        if (ui.item) {
          return;
        }

        // Search for a match (case-insensitive)
        var value = this.input.val(),
            valueLowerCase = value.toLowerCase(),
            valid = false;
        this.element.children("option").each(function () {
          if ($(this).text().toLowerCase() === valueLowerCase) {
            this.selected = valid = true;
            return false;
          }
        });

        // Found a match, nothing to do
        if (valid) {
          return;
        }

        // Remove invalid value
        this.input
            .val("")
            .attr("title", value + " didn't match any item")
            .tooltip("open");
        this.element.val("");
        this._delay(function () {
          this.input.tooltip("close").attr("title", "");
        }, 2500);
        this.input.autocomplete("instance").term = "";
      },

      _destroy: function () {
        this.wrapper.remove();
        this.element.show();
      }
    });
    $("#sale_item_id").combobox();
  });

  $('.total-cost').focus(function () {
    var unit = $('.unit-data').val();
    var price = $('.price-data').val();
    var total = unit * price;
    $(".total-cost").val(total);
  });
  $('.add-new').click(function () {
    var unit = $('.unit-data').val();
    var price = $('.price-data').val();
    var result = "unit: " + unit + "Price: " + price;
    console.log(result);
    var total = unit * price;
    $(".total-cost").val(total);
  });

  $('#sale_cost').focus(function () {
    if($('#sale_item_id').val() != " ") {
      console.log($('#sale_item_id').val());
      $.ajax({
        url: 'http://localhost:3000/sales/' + $('#sale_item_id').val() +'/getprice',
        error: function () {
          alert('An error has occurred');
        },
        success: function (data) {
          console.log(data);
         $('#sale_cost').val(data);
          $('#sale_cost').append(data);
        },
        type: 'GET'
      });
    }
  })
</script>
